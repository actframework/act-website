<!DOCTYPE html>
<html lang="@_lang">

<head>
    @head()
</head>

<body id="page-top">
    <nav id="mainNav" class="navbar navbar-default navbar-fixed-top">
        @nav(true)
    </nav>

    @args String docPath
    <section id="main">
        <div class="container">
            <span id="top"></span>
            <div id="doc-content">
            </div>
        </div>
    </section>

    <section id="footer" class="bg-primary">
        @footer()
    </section>

     @scripts()

    <script>
        $.get("@docPath", function(result) {
            var languageOverrides = {
                js: 'javascript'
            };

            if (typeof emojify != 'undefined') {
                emojify.setConfig({img_dir: 'emoji'});
            }

            var md = markdownit({
                html: true,
                highlight: function (code, lang) {
                    if (languageOverrides[lang]) lang = languageOverrides[lang];
                    if (!lang) {
                        lang = 'java';
                    }
                    if (lang === 'html' || lang === 'xml') {
                        var grammar = Prism.languages[lang];
                        var formatted = Prism.highlight(code, grammar, lang);
                        var match = code.match(/\n(?!$)/g);
                        var linesNum = match ? match.length + 1 : 1;
                        var lineNumbersWrapper;

                        var lines = new Array(linesNum + 1);
                        lines = lines.join('<span></span>');

                        lineNumbersWrapper = document.createElement('span');
                        lineNumbersWrapper.className = 'line-numbers-rows';
                        lineNumbersWrapper.innerHTML = lines;
                        return formatted + lineNumbersWrapper.outerHTML;
                    }
                    var codeElement = document.createElement("code");
                    codeElement.innerHTML = code;
                    codeElement.className = 'language-' + lang + ' line-numbers';
                    var preElement = document.createElement("pre");
                    preElement.appendChild(codeElement);
                    Prism.highlightElement(codeElement);
                    return codeElement.innerHTML;
                }
            }).use(markdownitFootnote);

            function setOutput(val) {
                val = val.replace(/<equation>((.*?\n)*?.*?)<\/equation>/ig, function (a, b) {
                    return '<img src="http://latex.codecogs.com/png.latex?' + encodeURIComponent(b) + '" />';
                });

                var out = document.getElementById('doc-content');
                if (!out) return
                var old = out.cloneNode(true);
                out.innerHTML = md.render(val);

                var allold = old.getElementsByTagName("*");
                if (allold === undefined) return;

                var allnew = out.getElementsByTagName("*");
                if (allnew === undefined) return;

                for (var i = 0, max = Math.min(allold.length, allnew.length); i < max; i++) {
                    if (!allold[i].isEqualNode(allnew[i])) {
                        out.scrollTop = allnew[i].offsetTop;
                        return;
                    }
                }

                if (window.location.hash) {
                    setTimeout(function() {
                        window.sr = ScrollReveal().reveal('#top');
                    }, 1);
                }
            }

            setOutput(result);

            // set anchor for all headers
            var r = /^\s*\[(.*)\](.*)/;
            $('#doc-content > h3, #doc-content > h4, #doc-content > h5').each(function(){
                var $h = $(this), s = $h.text(), v = r.exec(s), id = false;
                if (v) {
                    id = v[1];
                    $h.text(' ' + v[2]);
                }

                //$('<a id="' + nm0 + '"></a>').prependTo($h);
                var $section = $('<section></section>')
                $h.wrap($section.prop('id', id).addClass(this.tagName.toLowerCase()));
                if ($h.parent('section').hasClass('h3')) {
                    $h.parent('section').append('<i class="icon-double-angle-up pull-right back-to-top" title="back to top"></i>')
                } else {
                    $h.parent('section').append('<i class="icon-double-angle-up pull-right back-to-top" title="back to section top"></i>')
                }
            });
        })
    </script>
</body>

</html>
