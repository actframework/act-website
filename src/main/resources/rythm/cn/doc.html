@extends(layout, title = "ActFramework Home")

@section("moreJs") {
<script src="/js/site.js"></script>
<script src="/js/markdown-it.js"></script>
<script src="/js/markdown-it-footnote.js"></script>
<script src="/js/prism.js" charset="utf-8"></script>
}

@section("moreCss") {
<link rel="stylesheet" href="/css/prism.css">
<link rel="stylesheet" href="/css/prism-line-numbers.css">
}

<div class="container">
  <div class="navbar-spacer"></div>
  <nav class="navbar">
    <div class="container">
      <ul class="navbar-list">
        <li class="navbar-item"><a class="navbar-link" href="/#intro">介绍</a></li>
        <li class="navbar-item"><a class="navbar-link" href="/doc/index">文档</a></li>
        <li class="navbar-item"><a class="navbar-link" href="/#video">视频教程</a></li>
        <li class="navbar-item"><a class="navbar-link" href="/#start">开始使用Act！</a></li>
        <li class="navbar-item"><a class="navbar-link" href="/#support">技术支持</a></li>
        <li class="navbar-item"><a class="navbar-link" href="/#about">关于</a></li>
      </ul>
      <form action="/~i18n/locale" id="form_i18n" method="post">
        <input type="hidden" name="act_locale" value="zh_CN" id="act_locale">
      </form>
      <ul class="navbar-list u-pull-right">
        <li class="navbar-item"><a id="go_zh" class="navbar-link" href="#">中文</a></li>
        <li class="navbar-item u-pull-right"><a id="go_en" class="navbar-link" href="#">English</a></li>
      </ul>
    </div>
  </nav>

  @args String docPath
  <section id="doc-content">
  </section>

</div>

<script>
  $.get("@docPath", function(result) {
      var languageOverrides = {
          js: 'javascript'
      };

      if (typeof emojify != 'undefined') {
          emojify.setConfig({img_dir: 'emoji'});
      }

      var md = markdownit({
          html: true,
          highlight: function (code, lang) {
              if (languageOverrides[lang]) lang = languageOverrides[lang];
              if (!lang) {
                  lang = 'java';
              }
              if (lang === 'html' || lang == "xml") {
                  var grammar = Prism.languages[lang];
                  var formatted = Prism.highlight(code, grammar, lang);
                  var match = code.match(/\n(?!$)/g);
                  var linesNum = match ? match.length + 1 : 1;
                  var lineNumbersWrapper;

                  var lines = new Array(linesNum + 1);
                  lines = lines.join('<span></span>');

                  lineNumbersWrapper = document.createElement('span');
                  lineNumbersWrapper.className = 'line-numbers-rows';
                  lineNumbersWrapper.innerHTML = lines;
                  return formatted + lineNumbersWrapper.outerHTML;
              }
              var codeElement = document.createElement("code");
              codeElement.innerHTML = code;
              codeElement.className = 'language-' + lang + ' line-numbers';
              var preElement = document.createElement("pre");
              preElement.appendChild(codeElement);
              Prism.highlightElement(codeElement);
              return codeElement.innerHTML;
          }
      }).use(markdownitFootnote);

      function setOutput(val) {
          val = val.replace(/<equation>((.*?\n)*?.*?)<\/equation>/ig, function (a, b) {
              return '<img src="http://latex.codecogs.com/png.latex?' + encodeURIComponent(b) + '" />';
          });

          var out = document.getElementById('doc-content');
          if (!out) return
          var old = out.cloneNode(true);
          out.innerHTML = "<br/>" + md.render(val);
          if (typeof emojify != 'undefined') {
              emojify.run(out);
          }

          var allold = old.getElementsByTagName("*");
          if (allold === undefined) return;

          var allnew = out.getElementsByTagName("*");
          if (allnew === undefined) return;

          for (var i = 0, max = Math.min(allold.length, allnew.length); i < max; i++) {
              if (!allold[i].isEqualNode(allnew[i])) {
                  out.scrollTop = allnew[i].offsetTop;
                  return;
              }
          }
      }

      setOutput(result);

      // set anchor for all headers
      var r = /^\s*\[(.*)\](.*)/;
      $('#doc-content > h3, #doc-content > h4, #doc-content > h5').each(function(){
          var $h = $(this), s = $h.text(), v = r.exec(s), id = false;
          if (v) {
              id = v[1];
              $h.text(' ' + v[2]);
          }

          //$('<a id="' + nm0 + '"></a>').prependTo($h);
          var $section = $('<section></section>')
          $h.wrap($section.prop('id', id).addClass(this.tagName.toLowerCase()));
          if ($h.parent('section').hasClass('h3')) {
              $h.parent('section').append('<i class="icon-double-angle-up pull-right back-to-top" title="back to top"></i>')
          } else {
              $h.parent('section').append('<i class="icon-double-angle-up pull-right back-to-top" title="back to section top"></i>')
          }
      });

      function switchLocale(locale) {
          $('#act_locale').val(locale);
          $('#form_i18n').get(0).submit();
          return false;
      }

      $('body').on('click', '#go_en', function () {
          return switchLocale('en_AU');
      });
      $('body').on('click', '#go_zh', function () {
          return switchLocale('zh_CN');
      });
  })
</script>